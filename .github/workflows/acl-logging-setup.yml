name: Setup ACL Logging to Log Analytics

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      ledger_name:
        type: string
        description: "Confidential Ledger name"
        required: true

jobs:
  setup-logging:
    name: Setup ACL Logging
    runs-on: self-hosted
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Log into Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install PowerShell
        run: |
          # Check if PowerShell is already installed
          if command -v pwsh &> /dev/null; then
            echo "PowerShell is already installed:"
            pwsh --version
          else
            echo "Installing PowerShell..."
            curl -L -o /tmp/powershell.tar.gz https://github.com/PowerShell/PowerShell/releases/download/v7.4.2/powershell-7.4.2-linux-x64.tar.gz
            sudo mkdir -p /opt/microsoft/powershell/7
            sudo tar zxf /tmp/powershell.tar.gz -C /opt/microsoft/powershell/7
            sudo chmod +x /opt/microsoft/powershell/7/pwsh
            
            # Create symlink, removing existing one if it exists
            if [ -L /usr/bin/pwsh ] || [ -f /usr/bin/pwsh ]; then
              sudo rm /usr/bin/pwsh
            fi
            sudo ln -s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh
            pwsh --version
          fi

      - name: Install Az PowerShell Module
        run: |
          pwsh -Command '
            $ErrorActionPreference = "Continue"
            
            # Install modules directly without worrying about repository registration
            # PowerShellGet will use the default PSGallery even if registration shows errors
            Write-Host "Installing Az module..."
            Install-Module -Name Az -Scope CurrentUser -Force -AllowClobber -SkipPublisherCheck -ErrorAction Continue
            
            Write-Host "Installing Az.Monitor module..."
            Install-Module -Name Az.Monitor -Scope CurrentUser -Force -AllowClobber -SkipPublisherCheck -ErrorAction Continue
            
            # Verify installation
            Write-Host ""
            Write-Host "Verifying installations..."
            $azModule = Get-Module -ListAvailable -Name Az | Select-Object -First 1
            if ($azModule) {
              Write-Host "‚úÖ Az module installed: $($azModule.Version)"
            } else {
              Write-Host "‚ö†Ô∏è  Az module not found"
            }
            
            $monitorModule = Get-Module -ListAvailable -Name Az.Monitor | Select-Object -First 1
            if ($monitorModule) {
              Write-Host "‚úÖ Az.Monitor module installed: $($monitorModule.Version)"
            } else {
              Write-Host "‚ö†Ô∏è  Az.Monitor module not found"
            }
          '

      - name: Setup Logging Configuration
        env:
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ secrets.AZURE_LOG_ANALYTICS_RESOURCE_GROUP }}
          LEDGER_NAME: ${{ inputs.ledger_name }}
          LOG_ANALYTICS_WORKSPACE_NAME: ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
        run: |
          pwsh -Command '
            # Set error action preference
            $ErrorActionPreference = "Stop"
            
            # Import Az.Monitor module
            Import-Module Az.Monitor -Force
            
            # Construct ledger resource ID
            $ledger = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$env:RESOURCE_GROUP/providers/Microsoft.ConfidentialLedger/Ledgers/$env:LEDGER_NAME"
            
            Write-Host "üîç Retrieving diagnostic setting categories for ledger: $ledger"
            
            # Retrieve the category of logs available
            $categories = Get-AzDiagnosticSettingCategory -ResourceId $ledger
            Write-Host "Available categories:"
            $categories | Format-Table -AutoSize
            
            # Set up transaction logs
            Write-Host "üìù Setting up transaction logs..."
            $logtxn = New-AzDiagnosticSettingLogSettingsObject -Enabled $true -Category transactionlogs
            
            # Set up user-defined logs
            Write-Host "üìù Setting up user-defined logs..."
            $logudf = New-AzDiagnosticSettingLogSettingsObject -Enabled $true -Category userdefinedlogs
            
            # Set up logs directly with Log Analytics (if provided)
            if ($env:LOG_ANALYTICS_WORKSPACE_NAME -ne "") {
              Write-Host "üìä Configuring logs with Log Analytics Workspace: $env:LOG_ANALYTICS_WORKSPACE_NAME"
              $workspaceId = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$env:RESOURCE_GROUP/providers/Microsoft.operationalinsights/workspaces/$env:LOG_ANALYTICS_WORKSPACE_NAME"
              
              try {
                New-AzDiagnosticSetting -ResourceId $ledger -Name TXN_LOGS_LA -WorkspaceId $workspaceId -Log $logtxn -ErrorAction Stop
                Write-Host "‚úÖ Successfully configured transaction logs with Log Analytics Workspace"
              } catch {
                Write-Host "‚ö†Ô∏è  Warning: Failed to configure Log Analytics logging: $_" -ForegroundColor Yellow
              }
            } else {
              Write-Host "‚è≠Ô∏è  Skipping Log Analytics configuration (not provided)"
            }
            
            # Check existing configurations
            Write-Host "üîç Checking existing diagnostic settings..."
            $existingSettings = Get-AzDiagnosticSetting -ResourceId $ledger
            if ($existingSettings) {
              Write-Host "Current diagnostic settings:"
              $existingSettings | Format-List
            } else {
              Write-Host "No diagnostic settings found."
            }
            
            Write-Host "‚úÖ Logging configuration completed!"
          '
