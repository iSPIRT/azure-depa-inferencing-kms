name: Setup ACL Logging to Log Analytics

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      ledger_name:
        type: string
        description: "Confidential Ledger name"
        required: true

jobs:
  setup-logging:
    name: Setup ACL Logging
    runs-on: self-hosted
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Log into Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install PowerShell
        run: |
          # Install PowerShell
          curl -L -o /tmp/powershell.tar.gz https://github.com/PowerShell/PowerShell/releases/download/v7.4.2/powershell-7.4.2-linux-x64.tar.gz
          sudo mkdir -p /opt/microsoft/powershell/7
          sudo tar zxf /tmp/powershell.tar.gz -C /opt/microsoft/powershell/7
          sudo chmod +x /opt/microsoft/powershell/7/pwsh
          sudo ln -s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh
          pwsh --version

      - name: Install Az PowerShell Module
        run: |
          pwsh -Command '
            $ErrorActionPreference = "Continue"
            
            # Ensure PSGallery is registered and trusted
            if (-not (Get-PSRepository -Name PSGallery -ErrorAction SilentlyContinue)) {
              Register-PSRepository -Default -InstallationPolicy Trusted
            } else {
              Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
            }
            
            # Install/Update PowerShellGet first
            Install-Module -Name PowerShellGet -Repository PSGallery -Scope CurrentUser -Force -AllowClobber -SkipPublisherCheck
            
            # Import the updated PowerShellGet
            Import-Module PowerShellGet -Force
            
            # Install Az module with explicit repository
            Install-Module -Name Az -Repository PSGallery -Scope CurrentUser -Force -AllowClobber -SkipPublisherCheck
            
            # Verify installation
            Write-Host "Installed Az module version:"
            Get-Module -ListAvailable -Name Az | Select-Object -First 1 | Format-List Name, Version
          '

      - name: Setup Logging Configuration
        env:
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ secrets.AZURE_LOG_ANALYTICS_RESOURCE_GROUP }}
          LEDGER_NAME: ${{ inputs.ledger_name }}
          LOG_ANALYTICS_WORKSPACE_NAME: ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
        run: |
          pwsh -Command '
            # Set error action preference
            $ErrorActionPreference = "Stop"
            
            # Construct ledger resource ID
            $ledger = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$env:RESOURCE_GROUP/providers/Microsoft.ConfidentialLedger/Ledgers/$env:LEDGER_NAME"
            
            Write-Host "üîç Retrieving diagnostic setting categories for ledger: $ledger"
            
            # Retrieve the category of logs available
            $categories = Get-AzDiagnosticSettingCategory -ResourceId $ledger
            Write-Host "Available categories:"
            $categories | Format-Table -AutoSize
            
            # Set up transaction logs
            Write-Host "üìù Setting up transaction logs..."
            $logtxn = New-AzDiagnosticSettingLogSettingsObject -Enabled $true -Category transactionlogs
            
            # Set up user-defined logs
            Write-Host "üìù Setting up user-defined logs..."
            $logudf = New-AzDiagnosticSettingLogSettingsObject -Enabled $true -Category userdefinedlogs
            
            # Set up logs directly with Log Analytics (if provided)
            if ($env:LOG_ANALYTICS_WORKSPACE_NAME -ne "") {
              Write-Host "üìä Configuring logs with Log Analytics Workspace: $env:LOG_ANALYTICS_WORKSPACE_NAME"
              $workspaceId = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$env:RESOURCE_GROUP/providers/Microsoft.operationalinsights/workspaces/$env:LOG_ANALYTICS_WORKSPACE_NAME"
              
              try {
                New-AzDiagnosticSetting -ResourceId $ledger -Name TXN_LOGS_LA -WorkspaceId $workspaceId -Log $logtxn -ErrorAction Stop
                Write-Host "‚úÖ Successfully configured transaction logs with Log Analytics Workspace"
              } catch {
                Write-Host "‚ö†Ô∏è  Warning: Failed to configure Log Analytics logging: $_" -ForegroundColor Yellow
              }
            } else {
              Write-Host "‚è≠Ô∏è  Skipping Log Analytics configuration (not provided)"
            }
            
            # Check existing configurations
            Write-Host "üîç Checking existing diagnostic settings..."
            $existingSettings = Get-AzDiagnosticSetting -ResourceId $ledger
            if ($existingSettings) {
              Write-Host "Current diagnostic settings:"
              $existingSettings | Format-List
            } else {
              Write-Host "No diagnostic settings found."
            }
            
            Write-Host "‚úÖ Logging configuration completed!"
          '
