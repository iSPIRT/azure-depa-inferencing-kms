name: Setup ACL Logging to Log Analytics

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      ledger_name:
        type: string
        description: "Confidential Ledger name"
        required: true

jobs:
  setup-logging:
    name: Setup ACL Logging
    runs-on: self-hosted
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          # Check if Azure CLI is already installed
          if command -v az &> /dev/null; then
            echo "Azure CLI is already installed:"
            az --version
          else
            echo "Installing Azure CLI..."
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi

      - name: Log into Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install PowerShell
        run: |
          # Check if PowerShell is already installed
          if command -v pwsh &> /dev/null; then
            echo "PowerShell is already installed:"
            pwsh --version
          else
            echo "Installing PowerShell..."
            curl -L -o /tmp/powershell.tar.gz https://github.com/PowerShell/PowerShell/releases/download/v7.4.2/powershell-7.4.2-linux-x64.tar.gz
            sudo mkdir -p /opt/microsoft/powershell/7
            sudo tar zxf /tmp/powershell.tar.gz -C /opt/microsoft/powershell/7
            sudo chmod +x /opt/microsoft/powershell/7/pwsh
            
            # Create symlink, removing existing one if it exists
            if [ -L /usr/bin/pwsh ] || [ -f /usr/bin/pwsh ]; then
              sudo rm /usr/bin/pwsh
            fi
            sudo ln -s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh
            pwsh --version
          fi

      - name: Install Az PowerShell Module
        run: |
          # Check if modules are already installed
          pwsh -Command '
            $azModule = Get-Module -ListAvailable -Name Az | Select-Object -First 1
            $monitorModule = Get-Module -ListAvailable -Name Az.Monitor | Select-Object -First 1
            
            if ($azModule -and $monitorModule) {
              Write-Host "Az PowerShell modules are already installed:"
              Write-Host "‚úÖ Az module: $($azModule.Version) at $($azModule.ModuleBase)"
              Write-Host "‚úÖ Az.Monitor module: $($monitorModule.Version) at $($monitorModule.ModuleBase)"
              exit 0
            }
            
            Write-Host "Some modules are missing, installing..."
          '
          
          # Create directories for AllUsers modules
          sudo mkdir -p /usr/local/share/powershell/Modules
          sudo chmod 755 /usr/local/share/powershell/Modules
          
          # Install modules using AllUsers scope (avoids PowerShellGet user config issues)
          sudo pwsh -Command '
            $ErrorActionPreference = "Continue"
            
            # Register PSGallery for this session
            $null = Register-PSRepository -Default -InstallationPolicy Trusted -ErrorAction SilentlyContinue
            
            # Check and install Az module if needed
            $azModule = Get-Module -ListAvailable -Name Az | Select-Object -First 1
            if (-not $azModule) {
              Write-Host "Installing Az module..."
              Install-Module -Name Az -Scope AllUsers -Force -AllowClobber -SkipPublisherCheck -ErrorAction Continue
            } else {
              Write-Host "Az module already installed: $($azModule.Version)"
            }
            
            # Check and install Az.Monitor module if needed
            $monitorModule = Get-Module -ListAvailable -Name Az.Monitor | Select-Object -First 1
            if (-not $monitorModule) {
              Write-Host "Installing Az.Monitor module..."
              Install-Module -Name Az.Monitor -Scope AllUsers -Force -AllowClobber -SkipPublisherCheck -ErrorAction Continue
            } else {
              Write-Host "Az.Monitor module already installed: $($monitorModule.Version)"
            }
          '
          
          # Verify installation
          pwsh -Command '
            Write-Host "Verifying installations..."
            $azModule = Get-Module -ListAvailable -Name Az | Select-Object -First 1
            if ($azModule) {
              Write-Host "‚úÖ Az module found: $($azModule.Version) at $($azModule.ModuleBase)"
            } else {
              Write-Host "‚ö†Ô∏è  Az module not found"
            }
            
            $monitorModule = Get-Module -ListAvailable -Name Az.Monitor | Select-Object -First 1
            if ($monitorModule) {
              Write-Host "‚úÖ Az.Monitor module found: $($monitorModule.Version) at $($monitorModule.ModuleBase)"
            } else {
              Write-Host "‚ö†Ô∏è  Az.Monitor module not found"
            }
          '

      - name: Connect PowerShell to Azure
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          # Get access token from Azure CLI (which is already authenticated via azure/login action)
          export ACCESS_TOKEN=$(az account get-access-token --resource https://management.azure.com/ --query accessToken -o tsv)
          export TENANT_ID=$(az account show --query tenantId -o tsv)
          
          # Verify token was retrieved
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "Error: Failed to retrieve access token"
            exit 1
          fi
          
          pwsh -Command '
            $ErrorActionPreference = "Stop"
            
            # Import Az.Accounts module
            Import-Module Az.Accounts -Force
            
            # Connect using access token from Azure CLI
            Write-Host "Connecting to Azure using access token from Azure CLI..."
            if ([string]::IsNullOrEmpty($env:ACCESS_TOKEN)) {
              Write-Error "ACCESS_TOKEN environment variable is empty"
              exit 1
            }
            Connect-AzAccount -AccessToken $env:ACCESS_TOKEN -AccountId $env:AZURE_CLIENT_ID -TenantId $env:TENANT_ID -ErrorAction Stop
            
            # Set the subscription context
            Set-AzContext -SubscriptionId $env:AZURE_SUBSCRIPTION_ID -ErrorAction Stop
            
            Write-Host "‚úÖ Successfully connected to Azure"
            Get-AzContext | Format-List
          '

      - name: Setup Logging Configuration
        env:
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RESOURCE_GROUP: ${{ secrets.AZURE_LOG_ANALYTICS_RESOURCE_GROUP }}
          LEDGER_NAME: ${{ inputs.ledger_name }}
          LOG_ANALYTICS_WORKSPACE_NAME: ${{ secrets.AZURE_LOG_ANALYTICS_WORKSPACE_NAME }}
        run: |
          pwsh -Command '
            # Set error action preference
            $ErrorActionPreference = "Stop"
            
            # Import Az.Monitor module
            Import-Module Az.Monitor -Force
            
            # Construct ledger resource ID
            $ledger = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$env:RESOURCE_GROUP/providers/Microsoft.ConfidentialLedger/Ledgers/$env:LEDGER_NAME"
            
            Write-Host "üîç Retrieving diagnostic setting categories for ledger: $ledger"
            
            # Retrieve the category of logs available
            $categories = Get-AzDiagnosticSettingCategory -ResourceId $ledger
            Write-Host "Available categories:"
            $categories | Format-Table -AutoSize
            
            # Set up transaction logs
            Write-Host "üìù Setting up transaction logs..."
            $logtxn = New-AzDiagnosticSettingLogSettingsObject -Enabled $true -Category transactionlogs
            
            # Set up user-defined logs
            Write-Host "üìù Setting up user-defined logs..."
            $logudf = New-AzDiagnosticSettingLogSettingsObject -Enabled $true -Category userdefinedlogs
            
            # Set up logs directly with Log Analytics (if provided)
            if ($env:LOG_ANALYTICS_WORKSPACE_NAME -ne "") {
              Write-Host "üìä Configuring logs with Log Analytics Workspace: $env:LOG_ANALYTICS_WORKSPACE_NAME"
              $workspaceId = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$env:RESOURCE_GROUP/providers/Microsoft.operationalinsights/workspaces/$env:LOG_ANALYTICS_WORKSPACE_NAME"
              
              try {
                New-AzDiagnosticSetting -ResourceId $ledger -Name TXN_LOGS_LA -WorkspaceId $workspaceId -Log $logtxn -ErrorAction Stop
                Write-Host "‚úÖ Successfully configured transaction logs with Log Analytics Workspace"
              } catch {
                Write-Host "‚ö†Ô∏è  Warning: Failed to configure Log Analytics logging: $_" -ForegroundColor Yellow
              }
            } else {
              Write-Host "‚è≠Ô∏è  Skipping Log Analytics configuration (not provided)"
            }
            
            # Check existing configurations
            Write-Host "üîç Checking existing diagnostic settings..."
            $existingSettings = Get-AzDiagnosticSetting -ResourceId $ledger
            if ($existingSettings) {
              Write-Host "Current diagnostic settings:"
              $existingSettings | Format-List
            } else {
              Write-Host "No diagnostic settings found."
            }
            
            Write-Host "‚úÖ Logging configuration completed!"
          '
